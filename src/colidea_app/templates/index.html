<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>colidea-test-ufv · Generador de preguntas · UFV</title>
    <link rel="stylesheet" href="/static/css/main.css" />
  </head>
  <body>
    <header>
      <div class="tag-ufv">Comisión IA · UFV</div>
      <h1>
        Genera preguntas alineadas al modelo pedagógico UFV
        <br />en minutos, desde un temario o guía docente.
      </h1>
      <p>
        colidea-test-ufv transforma el temario que compartes en preguntas tipo test y de desarrollo, con niveles de
        Bloom, pistas que hablan el lenguaje de la Universidad y sugerencias listas para exportar.
      </p>
      <div class="hero-actions">
        <button class="btn-primary">Cargar temario</button>
        <button class="btn-secondary">Ver demostración</button>
        <a class="btn-secondary" href="/admin">Administración</a>
      </div>
    </header>

    <main>
      <section class="grid">
        <article class="panel-card">
          <h2>Sube tu guía docente</h2>
          <small>Documentos Word, PDF o texto plano. Mantendremos la confidencialidad.</small>
          <textarea id="syllabusInput" class="form-control" placeholder="Pega aquí un fragmento de tu temario ..."></textarea>
          <div class="form-row">
            <div class="field-block">
              <label for="bloomSelect">Niveles Bloom (múltiple)</label>
              <select id="bloomSelect" class="form-control multi-select" multiple size="3">
                <option value="Comprensión">Comprensión</option>
                <option value="Aplicación">Aplicación</option>
                <option value="Análisis">Análisis</option>
                <option value="Síntesis">Síntesis</option>
                <option value="Evaluación">Evaluación</option>
                <option value="Creación">Creación</option>
              </select>
            </div>
            <div class="field-block">
              <label for="typeSelect">Tipo de pregunta (múltiple)</label>
              <select id="typeSelect" class="form-control multi-select" multiple size="3">
                <option value="Tipo test">Tipo test</option>
                <option value="Seleccion multiple">Selección múltiple</option>
                <option value="Desarrollo">Desarrollo</option>
                <option value="Argumentación">Argumentación</option>
                <option value="Caso práctico">Caso práctico</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="field-block">
              <label for="alternativesSelect">Número de alternativas</label>
              <select id="alternativesSelect" class="form-control">
                <option value="2">2 opciones</option>
                <option value="3">3 opciones</option>
                <option value="4" selected>4 opciones</option>
                <option value="5">5 opciones</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <input id="fileUpload" type="file" class="form-control" accept=".pdf,.docx,.txt" />
            <button id="uploadButton" type="button" class="btn-secondary">Extraer texto</button>
          </div>
          <p id="uploadStatus" class="footer-note"></p>
          <div class="range-control">
            <label for="questionCount">Número de preguntas: <span id="questionCountValue">8</span></label>
            <input type="range" id="questionCount" min="3" max="10" value="8" />
          </div>
          <div class="tags">
            <span class="tag-ufv">Bloom</span>
            <span class="tag-ufv tag-secondary">Canvas</span>
            <span class="tag-ufv">Humanista</span>
          </div>
          <div class="hero-actions">
            <button id="generateButton" class="btn-primary" type="button">Generar preguntas</button>
            <button id="downloadCsvButton" class="btn-secondary" type="button">Descargar CSV</button>
          </div>
          <p id="generateStatus" class="footer-note"><em>Las preguntas generadas aparecerán aquí abajo.</em></p>
        </article>

        <article class="panel-card">
          <h2>Preguntas generadas</h2>
          <p>
            Cada pregunta se devuelve con su tipo, nivel cognitivo y pista. Puedes exportarlas a Excel, Word o preparar
            el CSV para importar a Canvas.
          </p>
          <ul id="generatedList" class="sample-questions">
            <li>
              <strong>[Desarrollo · Análisis]</strong>
              ¿Cómo anticipas los desafíos éticos del modelo de educación humanista en el proyecto que describes?
              <div class="hint">→ Pista: enlaza valores y compromiso personal.</div>
            </li>
            <li>
              <strong>[Tipo test · Aplicación]</strong>
              Marca la afirmación correcta sobre la evaluación formativa en la UFV.
              <div class="hint">→ Pista: recuerda que el diálogo y la retroalimentación importan más que la nota final.</div>
            </li>
            <li>
              <strong>[Desarrollo · Creación]</strong>
              Diseña un protocolo para acompañar al estudiante que presenta tu asignatura a un tribunal externo.
              <div class="hint">→ Pista: incluye estructura, rúbrica y relación con el modelo pedagógico.</div>
            </li>
          </ul>
        </article>
      </section>

      <section class="grid">
        <article class="panel-card">
          <h2>¿Qué sigue?</h2>
          <p>
            Canvas + Canvas New Quizzes en fase 2. Mientras tanto, generamos el CSV/Word que el profesorado ya conoce.
            También estamos trabajando para usar la paleta UFV y que la app se perciba como parte del campus digital.
          </p>
          <div class="footer-note">
            Modelo actual: <strong>{{ model }}</strong> · Proveedor: <strong>{{ provider }}</strong>
          </div>
        </article>
        <article class="panel-card">
          <h2>Indicadores de impacto</h2>
          <p>Mostramos datos orientativos para comunicar a la Comisión:</p>
          <ul class="sample-questions">
            <li>+30% de tiempo ahorrado en creación de preguntas.</li>
            <li>7 plantillas de Bloom configuradas.</li>
            <li>3 exportaciones (Word, CSV, Canvas-ready) disponibles.</li>
          </ul>
        </article>
      </section>
    </main>
    <script>
      const rangeInput = document.getElementById("questionCount");
      const valueLabel = document.getElementById("questionCountValue");
      const fileInput = document.getElementById("fileUpload");
      const uploadBtn = document.getElementById("uploadButton");
      const uploadStatus = document.getElementById("uploadStatus");
      const syllabusInput = document.getElementById("syllabusInput");
      const generateBtn = document.getElementById("generateButton");
      const downloadCsvButton = document.getElementById("downloadCsvButton");
      const generateStatus = document.getElementById("generateStatus");
      const generatedList = document.getElementById("generatedList");
      let latestQuestions = [];
      const bloomSelect = document.getElementById("bloomSelect");
      const typeSelect = document.getElementById("typeSelect");
      const alternativesSelect = document.getElementById("alternativesSelect");

      if (rangeInput && valueLabel) {
        rangeInput.addEventListener("input", () => {
          valueLabel.textContent = rangeInput.value;
        });
      }

      const selectedValues = (select) => {
        if (!select) return [];
        return Array.from(select.selectedOptions).map((opt) => opt.value || opt.textContent.trim());
      };

      const innerText = (value) => {
        if (typeof value === "string") return value;
        if (typeof value === "number") return String(value);
        if (typeof value === "boolean") return value ? "Sí" : "No";
        if (!value) return "";
        if (typeof value === "object") {
          if (typeof value.text === "string") return value.text;
          if (Array.isArray(value) && value.length) return value.map(innerText).filter(Boolean).join(", ");
          if (typeof value.content === "string") return value.content;
        }
        return JSON.stringify(value);
      };

      const renderGenerated = (questions) => {
        if (!generatedList) return;
        generatedList.innerHTML = "";
        if (!questions.length) {
          generatedList.innerHTML = "<li>No se generaron preguntas. Intenta ajustar los parámetros.</li>";
          return;
        }
        questions.forEach((q) => {
          const item = document.createElement("li");
          const header = document.createElement("strong");
          header.textContent = `[${innerText(q.question_type)} · ${innerText(q.cognitive_level)}]`;
          const body = document.createElement("p");
          body.textContent = innerText(q.question);
          item.appendChild(header);
          item.appendChild(body);

          const options = Array.isArray(q.options) ? q.options : [];
          if (options.length) {
            const optionsList = document.createElement("ul");
            optionsList.className = "options-list";
            options.forEach((opt, idx) => {
              const li = document.createElement("li");
              const label = String.fromCharCode(65 + idx);
              const rawOpt = innerText(opt);
              const marker = rawOpt === innerText(q.correct_option) ? " ✅" : "";
              li.textContent = `${label}) ${rawOpt}${marker}`;
              optionsList.appendChild(li);
            });
            item.appendChild(optionsList);
          }

          const hint = document.createElement("div");
          hint.className = "hint";
          hint.textContent = `→ Pista: ${innerText(q.answer_hint)}`;
          item.appendChild(hint);
          generatedList.appendChild(item);
        });
      };

      if (uploadBtn && fileInput && syllabusInput && uploadStatus) {
        uploadBtn.addEventListener("click", async () => {
          if (!fileInput.files.length) {
            uploadStatus.textContent = "Selecciona un archivo para extraer texto.";
            return;
          }
          const formData = new FormData();
          formData.append("file", fileInput.files[0]);
          uploadStatus.textContent = "Extrayendo texto...";
          try {
            const res = await fetch("/extract", { method: "POST", body: formData });
            if (!res.ok) {
              const error = await res.json().catch(() => ({}));
              throw new Error(error.detail || "La extracción falló.");
            }
            const data = await res.json();
            syllabusInput.value = data.text;
            uploadStatus.textContent = "Texto extraído correctamente.";
          } catch (err) {
            uploadStatus.textContent = err.message;
          }
        });
      }

      if (downloadCsvButton) {
        downloadCsvButton.addEventListener("click", () => {
          if (!latestQuestions.length) {
            generateStatus.textContent = "Primero genera preguntas para poder descargar el CSV.";
            return;
          }
          const headers = ["question", "question_type", "cognitive_level", "answer_hint", "options", "correct_option"];
          const escapeCsv = (value) => `"${String(value ?? "").replaceAll('"', '""')}"`;
          const rows = latestQuestions.map((q) => [
            q.question,
            q.question_type,
            q.cognitive_level,
            q.answer_hint,
            Array.isArray(q.options) ? q.options.join(" | ") : "",
            q.correct_option || "",
          ]);
          const csv = [headers, ...rows].map((row) => row.map(escapeCsv).join(",")).join("\n");
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "colidea_test_ufv_preguntas.csv";
          link.click();
          URL.revokeObjectURL(url);
        });
      }

      if (generateBtn) {
        generateBtn.addEventListener("click", async () => {
          if (!syllabusInput.value.trim()) {
            generateStatus.textContent = "Añade un temario o extrae texto para generar preguntas.";
            return;
          }
          const bloomLevels = selectedValues(bloomSelect);
          const questionTypes = selectedValues(typeSelect);
          const payload = {
            syllabus_text: syllabusInput.value,
            prompt_config: {
              bloom_levels: bloomLevels.length ? bloomLevels : ["Comprensión", "Aplicación", "Análisis"],
              question_types: questionTypes.length ? questionTypes : ["Tipo test", "Desarrollo"],
              number_of_questions: parseInt(rangeInput.value || "8", 10),
              number_of_alternatives: parseInt(alternativesSelect.value || "4", 10),
            },
          };
          generateBtn.disabled = true;
          generateStatus.textContent = "Generando preguntas...";
          try {
            const res = await fetch("/generate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              const error = await res.json().catch(() => ({}));
              throw new Error(error.detail || "No se pudieron generar preguntas.");
            }
            const data = await res.json();
            latestQuestions = Array.isArray(data) ? data : [];
            renderGenerated(latestQuestions);
            generateStatus.textContent = `Se han generado ${latestQuestions.length} preguntas.`;
          } catch (err) {
            generateStatus.textContent = err.message;
          } finally {
            generateBtn.disabled = false;
          }
        });
      }
    </script>
  </body>
</html>
